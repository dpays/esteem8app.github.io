<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/marked-element/marked-element.html">

<link rel="import" href="post-wrapper.html">
<link rel="import" href="post-path-list.html">
<link rel="import" href="github-repository.html">
<link rel="import" href="github-repository-file-view.html">
<link rel="import" href="google-docs-embedded.html">
<link rel="import" href="es8-button.html">
<link rel="import" href="prism-render.html">

<dom-module id="html-echo">
    <style>

        /* GENERAL */
        :host {
            display: block;
            overflow: auto;
        }

        ::selection {
            background: var(--app-light-primary-color);
            color: var(--app-primary-text-color);
        }

        .markdown-html .primary-color {
            color: var(--app-primary-color);
        }

        .markdown-html .secondary-color {
            color: var(--app-secondary-color);
        }

        .markdown-html .bold {
            font-weight: bold;
        }

        .markdown-html .low-priority {
            color: #8BC34A;
        }

        .markdown-html .medium-priority {
            color: #FFEB3B;
        }

        .markdown-html .high-priority {
            color: #FF5722;
        }

        .markdown-html .bold {
            font-weight: bold;
        }

        .markdown-html .bold {
            font-weight: bold;
        }

        .markdown-html p {
            margin-top: 18px;
            margin-bottom: 18px;
        }

        .markdown-html blockquote {
            margin-left: 0;
            margin-right: 0;
            padding: 4px;
            padding-left: 32px;
            padding-right: 16px;
            border-left: solid 2px var(--app-secondary-color);
            background-color: rgba(128, 128, 128, .1);
        }


        /* BASIC */
        .markdown-html a {
            color: var(--app-secondary-color) !important;
            text-decoration: none;
        }

        .markdown-html * {
            font-family: 'Open Sans', 'Roboto', sans-serif;
        }

        .markdown-html h1, .markdown-html h2, .markdown-html h3, .markdown-html h4, .markdown-html h5, .markdown-html h6 {
            color: var(--app-background-primary-text-color);
            font-family: 'Roboto', 'Open Sans', sans-serif;
        }

        .markdown-html img {
            max-width: 100%;
            height: auto;
            vertical-align: middle;
            margin-top: 4px;
            margin-bottom: 4px;
        }

        /* TABLES */
        .markdown-html table {
            width: 100%;
            border-collapse: collapse;
            overflow: scroll;
        }

        .markdown-html thead {
            background-color: rgba(128, 128, 128, .2);
        }

        .markdown-html table, .markdown-html th, .markdown-html td {
            border: 1px solid #ddd;
        }

        .markdown-html th, .markdown-html td {
            padding: 8px;
        }

        .markdown-html th a, .markdown-html td a {
            text-decoration: none;
        }

        .markdown-html th:hover, .markdown-html td:hover {
            background-color: rgba(128, 128, 128, .10);
        }

        .markdown-html th {
            font-weight: bold;
        }

        .markdown-html tr:hover {
            background-color: rgba(128, 128, 128, .15);
        }

        .markdown-html th:empty, .markdown-html td:empty {
            display: none;
        }

        /* APP Elements */
        .markdown-html post-path-list {
            width: 100%;
        }

        .markdown-html post-wrapper {
            width: 100%;
        }

        /* CUSTOM */
        .markdown-html .hidden {
            display: none;
        }

        .markdown-html .secondary-color {
            color: var(--app-secondary-color);
        }

        .markdown-html .primary-color {
            color: var(--app-primary-color);
        }

    </style>
    <template>
        <marked-element markdown="[[_htmlDisplayed]]">
            <div class="markdown-html">[[_htmlDisplayed]]</div>
        </marked-element>
    </template>
</dom-module>

<!--script src="../github/js-emoji/lib/emoji.min.js" type="text/javascript"></script-->

<script>

    (function () {

        Polymer({

            is: 'html-echo',

            properties: {

                html: {
                    type: String
                },

                _htmlDisplayed: {
                    type: String
                },

                _emoji: {
                    type: Object
                }
            },

            observers: ['_htmlChanged(html)'],

            ready: function() {

                // Add emoji converter
                //var emoji = new EmojiConvertor();

                // Set image sheets set
                /*emoji.img_sets = {
                    'apple'    : {'path' : '/src/github/js-emoji/build/emoji-data/img-apple-64/'   , 'sheet' : '/src/github/js-emoji/build/emoji-data/sheet_apple_64.png',    'mask' : 1 },
                    'google'   : {'path' : '/src/github/js-emoji/build/emoji-data/img-google-64/'  , 'sheet' : '/src/github/js-emoji/build/emoji-data/sheet_google_64.png',   'mask' : 2 },
                    'twitter'  : {'path' : '/src/github/js-emoji/build/emoji-data/img-twitter-64/' , 'sheet' : '/src/github/js-emoji/build/emoji-data/sheet_twitter_64.png',  'mask' : 4 },
                    'emojione' : {'path' : '/src/github/js-emoji/build/emoji-data/img-emojione-64/', 'sheet' : '/src/github/js-emoji/build/emoji-data/sheet_emojione_64.png', 'mask' : 8 }
                };*/

                /*emoji.use_sheet = true;
                emoji.init_env();

                emoji.img_set = 'apple';
                emoji.text_mode = false;

                // Set emoji properties
                emoji.addAliases({
                    'smile' : ':)'
                });*/

                //this.set('_emoji', emoji);

            },

            _htmlChanged: function (html) {

                //var html = this.html + ' :) ☺ ';

                // Render emoji
                /*html = this._emoji.replace_unified(html); // \u{1F604}
                html = this._emoji.replace_colons(html); // :smile:*/

                if(html.includes('― Leonardo da Vinci')){

                    //html += ' created/esteem8-features ';
                    html += ' https://github.com/esteem8app/esteem8app.github.io ';
                    //html += '  https://github.com/esteem8app/esteem8app.github.io/blob/master/src/scripts/intl-relativeformat-with-locales.min.js ';
                    //html += ' steem/@esteem8/esteem8-community-proposals ';
                    //html += ' steem/@primerz/what-is-steem ';
                    //html += ' https://www.youtube.com/watch?v=QdPivOm-gWc ';
                    //html += ' https://www.youtube.com/watch?v=QdPivOm-gWc '
                    //html += ' https://docs.google.com/document/d/1egC37b1veO5nXPmdpAGI0blNOxL9OQaGqNz8lKQp9os/edit  https://docs.google.com/spreadsheets/d/1jdugr0kNcXRrBsGh7u9mETp5oc06aILkihtq9Lg-vGY/edit ';
                    //html += ' [iframe$ratio=1:3&url=https://primerz.github.io/] ';
                    //html += ' https://soundcloud.com/ltj-bukem/ltj-bukem-return-to-atlantis ';
                }

                if(html.includes('You can create your own idea')) {

                    //html += ' https://github.com/esteem8app/esteem8app.github.io ';
                }

                // Relative link
                html = html.replace('https://steemit.com', '')
                           .replace('https://busy.org', '');

                // RENDER <a href into <img>
                /*var imageLinkARegex = /<a([ ="'a-zA-Z0-9-]+)? href=('|")[ .:_\/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??[ \/%&=a-zA-Z0-9-]*("|')>[ .:_\/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??[ \/%&=a-zA-Z0-9-]*<\/a>/gm;
                html = html.replace(imageLinkARegex, function(match){

                    var imgUrlRegex = /(https?:\/\/)?(\w+.)?\w+.\w+[ \/%&a-zA-Z0-9-]+.(jpg|png|gif|jpeg)\??([ \/%&=a-zA-Z0-9-]+)?/g;
                    var url = imgUrlRegex.exec(match)[0];

                    url = url.replace(/ /gm, '');

                    return '<img src="' + url + '" ></img>';
                });*/

                // Custom element
                /* [iframe$ratio=1:3&url=https://primerz.github.io/]
                 * [postWrapper$post-path=/introduceyourself/@fayehalliday/an-introduction-with-love-from-faye-halliday-artist-and-travel-junkie]
                 * [button$text=my github&url=https://primerz.github.io/]
                 */

                var customElementRegex = /\[(iframe|steem tag|button|postWrapper)(\$)?([\/.=&@:a-zA-Z0-9\?\- ]+)?]/gm;
                html = html.replace(customElementRegex, function(match) {

                    // Clean match
                    //var match = match.replace(/ /g, "");
                    var match = match.replace("[", "");
                    var match = match.replace("]", "");

                    // Element type (iframe, ...)
                    var rawElement = match.split("$")[0];

                    // Parameters (ratio, url, ...)
                    var options = match.split("$")[1].split("&") || [];

                    // Parameters pre-defined (B.E. for iframe prompt-user)
                    var preDefinedAttributes = [];

                    // Element type for app (iframe -> responsive-iframe)
                    var appElement = '';

                    // Get element type
                    switch (rawElement) {

                        case 'iframe':
                            appElement = 'responsive-iframe';
                            preDefinedAttributes.push(['prompt-user', 'true']);
                            break;

                        case 'postWrapper':
                            appElement = 'post-wrapper';
                            break;

                        case 'button':
                            appElement = 'es8-button';
                            break;
                    }

                    //Add parameters (attribute and value)
                    var attributes = preDefinedAttributes; // Array of attributes & value

                    for(var i = 0; i < options.length;i++) {

                        var attribute = []; // Attribute [attributeName, value]

                        var attr = options[i].split('=')[0]; // attr
                        var val = options[i].replace(attr, '').replace('=', ''); // value = (attr + val) - attr

                        attribute.push(attr);
                        attribute.push(val);

                        attributes.push(attribute);

                    }

                    // Create html
                    var html = '<'+ appElement + ' ';

                    for (var i = 0; i < attributes.length; i++) {

                        html += attributes[i][0] + '="' + attributes[i][1] + '" ';
                    }

                    html += '></' + appElement + '>';

                    return html;
                });


                // RENDER Markdown image -> ![image alt text](src)
                var markdwonImageRegex = /!\[[ a-zA-Z0-9]*\]\([:&=%\/.=?a-zA-Z0-9-]*\)/gm;
                html = html.replace(markdwonImageRegex, function(match){

                    var url = match.replace(/!\[[ a-zA-Z0-9]*\]\(/g, '').replace(')', '').replace(/ /gm, '');

                    return '<img src="' + url + '" ></img>';
                });

                // RENDER Direct image link -> https://a.domain.org/
                var directImageLinkRegex = /.?http[ :.=_\-a-zA-Z0-9\/\%]*.(jpg|png|gif|jpeg)[ \/\%&=a-zA-Z0-9\?\.]*/gm;
                html = html.replace(directImageLinkRegex, function(match){

                    var firstChar = match.substring(0, 1);

                    if(firstChar == '>' || firstChar == '"' || firstChar == "'" || firstChar == "(") {

                        // If link is not link text but html or markdown link
                        return match;
                    }else {

                        // Link is pure text
                        var url = match.replace(/ /gm, '');
                        return '<img src="' + url + '" ></img>';
                    }
                });


                var commentProjectElement = /(\[((objectives?|composition|strategy|strategies|projects?|tasks?)]))/gm;
                html = html.replace(commentProjectElement, function(match){

                    return '<span class="primary-color">' + match + '</span>';
                });

                var postPriorityElement = /(\[(?:very )?(low|medium|high) (priority)\])/gm;
                html = html.replace(postPriorityElement, function(match){

                    var priorityColorRegex = /((low|medium|high) priority)/g;
                    var priorityColor = imgUrlRegex.exec(match)[0];
                    priorityColor = priorityColor.replace(" ", "-");

                    return '<span class="' + priorityColor + '">' + match + '</span>';
                });

                // RENDER `` -> prism-render
                var markdownCodeRegex = /`+[a-zA-Z0-9 \(\)\{\}\/\\\<\>\n\r\t\:\;\.\=\'\"\^\?\+\-\,\*\%\&\@\~\[\]\#\|\$\°\§\!\£]*`+/gm;
                html = html.replace(markdownCodeRegex, function(match){

                    var code = match.replace(/`/g, '');

                    return '<prism-render code="' + code + '" background-color="rgba(128, 128, 128, .2)"></prism-render>';
                });


                // RENDER <pre><code></code></pre> -> prims-render
                var htmlCodeRegex = /<pre>[\n \t \r]*<code>[a-zA-Z0-9 \(\)\{\}\/\\\<\>\n\r\t\:\;\.\=\'\"\^\?\+\-\,\*\%\&\@\~\[\]\#\|\$\°\§\!\£]*<\/code>[\n \t \r]*<\/pre>/gm;
                html = html.replace(markdownCodeRegex, function(match){

                    var code = match.replace(/<pre>[\n \t \r]*<code>/g, '').replace(/<\/code>[\n \t \r]*<\/pre>/g, '');

                    return '<prism-render code="' + code + '" background-color="rgba(128, 128, 128, .2)"></prism-render>';
                });

                // RENDER direct image link into <img> (must not be yet in <img>)

                /* RENDER in-app elements from link*/

                // Tag path -> <post-path-list>
                /*var tagPathRegex = /[^("|'|[)](created|hot|trending|active)\/[a-zA-Z0-9-]+/gm;
                 html = html.replace(tagPathRegex, function(match){

                 var match = match.replace(" ", "");
                 console.log(match);
                 return '<post-path-list steem-path="' + match + '" post-type="card-light"></post-path-list>';
                 });

                 // User path -> <post-path-list>
                 var tagPathRegex = /[^(\/|"|'|[)]\/@[a-zA-Z0-9-]+/gm;
                 html = html.replace(tagPathRegex, function(match){

                 var match = match.replace(" ", "");
                 return '<post-path-list steem-path="' + match + '" post-type="card-light"></post-path-list>';
                 });
                 */
                // Post path -> <post>
                var postPathRegex = /.?(\/)?[a-zA-Z0-9-]+\/@[a-zA-Z0-9-]+\/[a-zA-Z0-9-]+/gm;
                html = html.replace(postPathRegex, function(match){

                    if(match.charAt(0) !== ' '){

                        return match;
                    }

                    var match = match.replace(/ /g, "");
                    return '<post-wrapper steem-path="' + match + '" post-type="content-minimal"></post-wrapper>';
                });

                // Github repository path -> <github-repository>
                var gitHubRepositoryRegex = /[^("|'|[)]https:\/\/github\.com\/[a-zA-Z0-9-]+\/[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+ /gm
                html = html.replace(gitHubRepositoryRegex, function(match){

                    var match = match.replace(/ /g, "");
                    return '<github-repository repository="' + match + '" ></github-repository>';
                });

                // Github file view -> <github-repository-file-view>
                var gitHubRepositoryFileRegex = /.?https:\/\/github.com\/[a-zA-Z0-9]+\/[\.a-zA-Z0-9-]+\/blob\/\w+\/[\.\/a-zA-Z0-9-]+/gm
                html = html.replace(gitHubRepositoryFileRegex, function(match){

                    if(match.includes('"') || match.includes('\'') || match.includes('[')) {

                        return match;
                    }

                    var match = match.replace(/ /g, "");
                    return '<github-repository-file-view file-url="' + match + '" ></github-repository-file-view>';
                });

                // Consider it link -> <responsive-iframe>
                var considerItRegex = /[^("|'|[)]https:\/\/[a-zA-Z0-9-]+\.[a-zA-Z0-9-]+\.it\//gm;
                html = html.replace(considerItRegex, function(match){

                    var url = match.replace(/ /g, "");
                    return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                });

                var youtubeVideoHtmlLinkregex = /<a[ a-zA-Z0-9\=\"\'\w]* href=("|')https:\/\/www\.[a-zA-Z0-9-]+\.com\/(watch\?v=|embed\/)[_a-zA-Z0-9-]+("|')>[a-zA-Z0-9:\/.?=]*<\/a>/gm
                html = html.replace(youtubeVideoHtmlLinkregex, function(matchString){

                    var match = matchString.match(/("|')https:\/\/www\.[a-zA-Z0-9-]+\.com\/(watch\?v=|embed\/)[_a-zA-Z0-9-]+("|')/g, "");
                    var url = match.replace("https://www.youtube.com/watch?v=", "https://www.youtube.com/embed/")
                                   .replace(/\"/g, '').replace(/\'/g, '');

                    return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                });

                var youtubeVideoMarkdownLinkregex = /\[[a-zA-Z0-9\=\"\'\w]*\]\(https:\/\/www\.[a-zA-Z0-9-]+\.com\/(watch\?v=|embed\/)[_a-zA-Z0-9-]+("|')>[a-zA-Z0-9:\/.?=]*\)/gm
                html = html.replace(youtubeVideoMarkdownLinkregex, function(matchString){

                    var match = matchString.match(/https:\/\/www\.[a-zA-Z0-9-]+\.com\/(watch\?v=|embed\/)[_a-zA-Z0-9-]+/g, "");
                    var url = match.replace("https://www.youtube.com/watch?v=", "https://www.youtube.com/embed/")
                            .replace(/ /g, '');

                    return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                });

                // Youtube short video link
                /*var youtubeShortVdeoLinkRegex = /.?https:\/\/youtu\.be\/[a-zA-Z0-9]+/gm;
                html = html.replace(youtubeShortVdeoLinkRegex, function(matchedString){

                    var firstChar = matchedString.substring(0, 1);

                    if(firstChar == '>' || firstChar == '"' || firstChar == "'" || firstChar == "(") {

                        // If link is not link text but html or markdown link
                        return matchedString;
                    }else {

                        matchedString = matchedString.match(/https:\/\/youtu\.be\/[a-zA-Z0-9]+/g);
                        var url = matchedString.replace("https://youtu.be/", "https://www.youtube.com/embed/");

                        return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                    }

                });*/

                // Youtube video link
                var youtubeVideoLinkregex = /https:\/\/www\.[a-zA-Z0-9-]+\.com\/(watch\?v=|embed\/)[_a-zA-Z0-9-]+/gm
                html = html.replace(youtubeVideoLinkregex, function(match){

                    var match = match.replace(/ /g, "");
                    var url = match.replace("https://www.youtube.com/watch?v=", "https://www.youtube.com/embed/");

                    return '<responsive-iframe url="' + url + '" ></responsive-iframe>';
                });

                // Soundcloud track + maybe other soundcloud elements
                var soundcloudSoundRegex = /https:\/\/soundcloud.com\/[a-zA-Z0-9-]*\/[a-zA-Z0-9-?=\/]*/gm;
                html = html.replace(soundcloudSoundRegex, function(match){

                    var match = match.replace(/ /g, "");
                    var url = 'https://w.soundcloud.com/player/?url=' + match;

                    return '<responsive-iframe ratio="24:9" url="' + url + '" ></responsive-iframe>';
                });

                // PDF
                // https://customelements.io/streetturtle/pdf-element/

                // Google docs -> <google-docs-embedded>
                var googleDocsRegex = /[^("|'|[)]https:\/\/(docs|www)\.google\.com\/(presentation|document|spreadsheets|forms|drawings|maps)\/d\/(e\/)?(u\/)?(0\/)?[_?=\-.a-zA-Z0-9-]*\/[%\-.?&a-zA-Z0-9-#=]*/gm;
                html = html.replace(googleDocsRegex, function(match){

                    var match = match.replace(/ /g, "");
                    var url = '';

                    if(!match.includes('maps')) {

                        // Url can be one that is publicly published or one that we used in editor
                        var rawDocummentUrlRegex = /https:\/\/(docs|www)\.google\.com\/(presentation|document|spreadsheets|forms|drawings|maps)\/d\/(e\/)?[_?=\-.a-zA-Z0-9-]*\//g
                        url = rawDocummentUrlRegex.exec(match)[0];

                        if(url.includes('https://docs.google.com/presentation')) {

                            url += 'embed';
                        }

                        if(url.includes('https://docs.google.com/document')){

                            url += 'pub?embedded=true';
                        }

                        if(url.includes('https://docs.google.com/spreadsheets')) {

                            url += 'pubhtml';
                        }

                        if(url.includes('https://docs.google.com/forms')) {

                            url += 'viewform';
                        }

                        if(url.includes('https://docs.google.com/drawings')) {

                            url += 'pub';
                        }

                    }else if(match.includes('maps')) {

                        url = 'https://www.google.com/maps/d/u/0/embed?';

                        var rawMapUrlRegx = /mid=[_a-zA-Z0-9-]*/g;
                        var mid = rawMapUrlRegx.exec(match)[0];

                        url += mid;
                    }


                    return '<google-docs-embedded url="' + url + '" ></google-docs-embedded>';
                });

                // Google site
                var googleSiteRegex = /[^("|'|[)]https:\/\/sites\.google\.com\/view\/[_a-zA-Z0-9-]*\//gm;
                html = html.replace(googleSiteRegex, function(match) {

                    var url = match.replace(/ /g, "");

                    return '<responsive-iframe url="' + url + '" ratio="3:1" ></responsive-iframe>';
                });

                // Tag #tag
                /*var tagRegex = /.?#[a-zA-Z0-9-]+/gm;
                html = html.replace(tagRegex, function(match){

                    if(match.charAt(0) != ' ') {

                        return match;
                    }

                    var url = match.replace('#', '');

                    return '<a href="/hot/' + url + '" >' + match + '</a>';
                });

                // User @username
                var userRegex = /.?@[a-zA-Z0-9-]+/gm;
                html = html.replace(userRegex, function(match){

                    if(match.charAt(0) != ' ') {

                        return match;
                    }

                    return '<a href="/' + match + '" >' + match + '</a>';
                });*/

                // REGEX tester https://regex101.com/

                this._htmlDisplayed = html;

                /* TODO
                 * [ ] implement set post type from link such as [$card-light:/path]
                 * [X] Render markdown as HTML
                 * [ ] transform links into HTML or Custom elements such as [$iframe:urlXYZ] || [$post.author] || [$button:value=follow [$post.author.account.field_signature] type=follow action=follow [$post.author]] or something easier that can work together with other CE maybe with html logic
                 * [ ] transform absolute url that can be used by the app into relative to make theme functional
                 * [ ] Sanitize HTML
                 */

                /*
                 * IDEAS
                 * Email form maybe with https://formspree.io
                 * Github HTML API file
                 * Github HTML API folder
                 * Github HTML API organization
                 * Github HTML API Account
                 * Github JS API implementation
                 * Raw video extraction from yt and + with custom video player found on customelement.io
                 * soundcloud JS API implementation https://developers.soundcloud.com/docs/api/guide
                 * Discord embedded on desktop or link on mobile
                 * Render code with prism render
                 */

            }
        });
    })();
</script>