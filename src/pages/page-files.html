<link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-drawer-panel/paper-drawer-panel.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-toast/paper-toast.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-input/paper-textarea.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-toggle-button/paper-toggle-button.html">

<link rel="import" href="../../bower_components/paper-tags/paper-tags.html">
<link rel="import" href="../../bower_components/paper-tags/paper-tags-input.html">

<link rel="import" href="../components/my-icons.html">
<link rel="import" href="../components/file-card.html">
<link rel="import" href="../components/html-echo.html">

<link rel="import" href="../drawer/tools-drawer.html">

<link rel="import" href="../dialogs/select-folder-dialog.html">
<link rel="import" href="../dialogs/manage-folders-dialog.html">

<link rel="import" href="../shared-styles.html">

<dom-module id="page-files">

    <template>

        <style include="shared-styles">

            /* GENERAL */
            :host {
                min-height: calc(100% - 16px);
                margin: 0;
                position: absolute;
                width: 100%;
                margin-top: -16px;
                padding-top: 16px;
                padding-bottom: 16px;
                display: block;
                background-color: var(--app-primary-background-color);
                overflow: hidden;
            }

            #fileOptionToolbar {
                background-color: var(--app-dark-primary-color);
                color: var(--app-primary-text-color);
                width: 100%;
                cursor: pointer;
            }

            .floatingToolbarTitle div {
                display: inline;
            }

            #mainToolbar {
                z-index: 5;
            }

            .mainToolbar .bottom div {
                display: inline;
            }

            .mainToolbar .bottom div[hidden] {
                display: none;
            }

            .dark-primary {
                text-align: right;
                width: 100%;
            }

            #files {
                margin-top: 128px;
            }

            .file-cards {
                @apply(--layout-horizontal);
                @apply(--layout-wrap);
            }

            file-card {
                background-color: rgba(128, 128, 128, 0);
                transition: background-color ease-out .1s;
            }

            file-card.iron-selected {
                background-color: rgba(128, 128, 128, 0.4);
                transition: background-color ease-in .1s;
            }

            #addFileFab {
                background-color: var(--app-secondary-color);
                color: var(--app-secondary-text-color);
                position: fixed;
                bottom: 16px;
                right: 16px;
                z-index: 4;
            }

            paper-dialog {
                background-color: var(--app-secondary-background-color);
                color: var(--app-background-primary-text-color)
            }

            paper-dialog .buttons paper-button {
                color: var(--app-secondary-color);
            }

            .toggle {
                height: 64px;
                line-height: 64px;
            }

            .toggle paper-toggle-button {
                float: right;
                margin-top: 18px;
            }

            paper-toggle-button {
                --paper-toggle-button-checked-bar-color: var(--app-secondary-color);
                --paper-toggle-button-checked-button-color:  var(--app-secondary-color);
                --paper-toggle-button-checked-ink-color:  var(--app-secondary-color);
            }

            paper-input, paper-tags-input, paper-textarea {
                --paper-input-container-focus-color: var(--app-secondary-color);
                --paper-input-container-input-color: var(--app-background-primary-text-color);
                --paper-input-container-color: var(--app-background-secondary-text-color);
            }

            paper-tags, paper-tags-input {
                --paper-tag-margin: 4px;
                --paper-tag-focus-color: var(--app-secondary-color);
                --paper-tag-text-color: var(--app-background-primary-text-color);
                --paper-tags-item: {
                    padding-left: 8px !important;
                    color: var(--app-secondary-color) !important;
                };
            }

            .closeViewButton {
                color: var(--app-background-primary-text-color);
                position: absolute;
                right: 0;
                top: 0;
                padding: 8px !important;
                margin: 16px;
            }

            #viewFileDialog h2 {
                display: inline;
            }

            #openEditFileButton {
                padding: 8px;
            }

            #noFileText {
                text-align: center;
                width: 100%;
                padding-top: 36px;
                color: var(--app-background-primary-text-color);
            }


        </style>

        <tools-drawer id="toolsDrawer"></tools-drawer>

        <select-folder-dialog id="selectFolderDialog"
                              selected-folder="{{query}}"
                              favorite-folders="{{favoriteFolders}}"
                              is-manage-folders-dialog-opened="{{_isManageFoldersDialogOpened}}">>
        </select-folder-dialog>

        <manage-folders-dialog id="manageFoldersDialog"
                               opened="{{_isManageFoldersDialogOpened}}"
                               folders="{{favoriteFolders}}"
                               favorite-shared-categories="{{favoriteSharedFolders}}">
        </manage-folders-dialog>

        <!-- TOOLBAR -->
        <paper-toolbar id="mainToolbar"
                       class="mainToolbar medium-tall">

            <paper-icon-button icon="my-icons:menu"
                               id="toggleDrawerMenu"
                               on-tap="_openDrawer()">
            </paper-icon-button>
            <div id="floatingToolbar"
                 on-tap="_openSelectFolderDialog()"
                 class="floatingToolbar">
                <span class="floatingToolbarTitle">
                    #[[query]]
                </span>
            </div>

            <paper-icon-button id="toolsDrawerButton"
                               on-tap="_openToolsDrawer()"
                               icon="my-icons:apps">
            </paper-icon-button>

            <div class="bottom right dark-primary">

                <div hidden="[[!_multipleSelected(_selectedFilesId.length)]]">
                    <paper-icon-button id="openConfirmationDeleteFileButton"
                                       on-tap="_openConfirmationRemoveFilesDialog()"
                                       icon="my-icons:delete">
                    </paper-icon-button>
                </div>

                <div hidden="[[!_multipleSelected(_selectedFilesId.length)]]">
                    <paper-icon-button id="openFileLinkButton"
                                       on-tap="_openFileLink()"
                                       icon="my-icons:link">
                    </paper-icon-button>
                </div>

                <div hidden="[[!_multipleSelected(_selectedFilesId.length)]]">
                    <paper-icon-button id="copyFileLinkButton"
                                       on-tap="_copyFileLink()"
                                       icon="my-icons:copy">
                    </paper-icon-button>
                </div>

            </div>
        </paper-toolbar>

        <!-- Confirmation remove from favorite -->
        <paper-dialog id="confirmationRemoveFilesDialog"
                      entry-animation="fade-in-animation"
                      exit-animation="fade-out-animation"
                      with-backdrop>

            <h2>Confirmation</h2>
            <p>Remove
                <span class="secondary-color">[[_selectedFilesId.length]]</span>
                files from favorite ?
            </p>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    Cancel
                </paper-button>
                <paper-button dialog-confirm
                              autofocus
                              id="deleteFileButton"
                              on-tap="_deleteFile()">
                    Yes
                </paper-button>
            </div>
        </paper-dialog>

        <!-- Add a file to favorite -->
        <paper-dialog id="addFileDialog"
                      class="bigDialog withBottomAction"
                      entry-animation="fade-in-animation"
                      exit-animation="fade-out-animation"
                      with-backdrop>

            <h2>Add a file</h2>

            <paper-icon-button class="closeViewButton"
                               icon="my-icons:close"
                               dialog-dismiss>
            </paper-icon-button>

            <div class="scrollable">

                <paper-input label="Name"
                             value="{{_currentFile.name}}">
                </paper-input>

                <paper-textarea label="Url or Text"
                                value="{{_currentFile.content}}">
                </paper-textarea>

                <paper-tags-input label="Tags"
                                  items="{{_currentFile.manualTags}}">
                </paper-tags-input>

                <div class="toggle">
                    <span>Share file</span>
                    <paper-toggle-button checked="{{_currentFile.shared}}"></paper-toggle-button>
                </div>

                <div class="defaultTags">
                    <paper-tags items="{{_currentFile.defaultTags}}"></paper-tags>
                </div>

            </div>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    Cancel
                </paper-button>
                <paper-button dialog-confirm
                              autofocus
                              id="addFileButton"
                              on-tap="_addFile()">
                    Add
                </paper-button>
            </div>
        </paper-dialog>

        <!-- Edit a file from favorite -->
        <paper-dialog id="editFileDialog"
                      class="bigDialog withBottomAction">

            <h2>Edit a file</h2>

            <paper-icon-button class="closeViewButton"
                               icon="my-icons:close"
                               dialog-dismiss>
            </paper-icon-button>

            <div class="scrollable">

                <paper-input label="Name"
                             value="{{_currentFile.name}}">
                </paper-input>

                <paper-textarea label="Url or Text"
                                value="{{_currentFile.content}}">
                </paper-textarea>

                <paper-tags-input label="Tags"
                                  items="{{_currentFile.manualTags}}">
                </paper-tags-input>

                <div class="toggle">
                    <span>Share file</span>
                    <paper-toggle-button checked="{{_currentFile.shared}}"></paper-toggle-button>
                </div>

                <div class="defaultTags">
                    <paper-tags items="{{_currentFile.defaultTags}}"></paper-tags>
                </div>

            </div>

            <div class="buttons">
                <paper-button dialog-dismiss>
                    Cancel
                </paper-button>
                <paper-button dialog-confirm
                              autofocus
                              id="saveFileButton"
                              on-tap="_saveFile()">
                    Save
                </paper-button>
            </div>
        </paper-dialog>

        <!-- View a file -->
        <paper-dialog id="viewFileDialog"
                      class="bigDialog"
                      entry-animation="fade-in-animation"
                      exit-animation="fade-out-animation"
                      with-backdrop>

            <h2>[[_currentFile.name]]</h2>

            <paper-icon-button icon="my-icons:edit"
                          id="openEditFileButton"
                          on-tap="_openEditFileDialog()">
            </paper-icon-button>

            <paper-icon-button class="closeViewButton"
                               icon="my-icons:close"
                               dialog-dismiss>
            </paper-icon-button>

            <div class="scrollable">
                <html-echo html=" [[_currentFile.content]] "></html-echo>
            </div>

        </paper-dialog>

        <div id="files">

            <template is="dom-if" if="[[!favoriteFiles.length]]">
                <h2 id="noFileText">You don't have any files</h2>
            </template>

            <template is="dom-if" if="[[favoriteFiles.length]]">
                <div class="file-cards">
                        <template is="dom-repeat" items="[[favoriteFiles]]"
                                  filter="{{computeFilter(query)}}">
                            <file-card file="[[item]]"
                                       file-id="[[item.id]]"
                                       action="{{_action}}"
                                       selected-files="{{_selectedFilesId}}">
                            </file-card>
                        </template>
                </div>
            </template>

        </div>

        <paper-fab id="addFileFab"
                   on-tap="_openAddFileDialog()"
                   icon="my-icons:add">
        </paper-fab>

    </template>
</dom-module>

<script>

    Polymer({

        is: 'page-files',

        properties: {

            settings: {
                type: Object
            },

            favoriteFiles: {
                type: Array,
                notify: true
            },

            favoriteSharedFiles: {
                type: Array,
                notify: true
            },

            _previousFavoriteFiles: {
                type: Array
            },

            favoriteFolders: {
                type: Array,
                notify: true
            },

            // Selected folder (query)
            query: {
                type: String,
                notify: true
            },

            // Current file
            _currentFile: {
                type: Object
            },

            // Selected files id
            _selectedFilesId: {
                type: Array
            },

            // Action object {type: "type", id: "id"}
            _action: {
                type: Object
            },

            _isManageFoldersDialogOpened: {
                type: Boolean
            }
        },

        observers: [
            '_setCurrentFileName(_currentFile.content)',
            '_setCurrentFileDefaultTags(_currentFile.content)',
            '_doAction(_action.type, _action.id)',
            '_changeUrl(query)'
        ],

        ready: function() {

            this.pastFiles = this.favoriteFiles;
            this._selectedFilesId = [];
            this._resetCurrentFile();

            this.$.toggleDrawerMenu.addEventListener('tap', this._openDrawer.bind(this));
            this.$.toolsDrawerButton.addEventListener('tap', this._openToolsDrawer.bind(this));

            this.$.floatingToolbar.addEventListener('tap', this._openSelectFolderDialog.bind(this));

            this.$.deleteFileButton.addEventListener('tap', this._deleteFile.bind(this));
            this.$.openFileLinkButton.addEventListener('tap', this._openFileLink.bind(this));
            this.$.addFileFab.addEventListener('tap', this._openAddFileDialog.bind(this));
            this.$.addFileButton.addEventListener('tap', this._addFile.bind(this));

            this.$.openEditFileButton.addEventListener('tap', this._openEditFileDialog.bind(this));
            this.$.openConfirmationDeleteFileButton.addEventListener('tap', this._openConfirmationRemoveFilesDialog.bind(this));

            this.$.saveFileButton.addEventListener('tap', this._saveFile.bind(this));
            this.$.copyFileLinkButton.addEventListener('tap', this._copyFileLink.bind(this));
        },

        _changeUrl: function(query) {

            window.history.pushState({}, null, '/files/'+query);
        },

        /* OPEN SOMETHING FUNCTIONS */

        // Open side drawer (menu)
        _openDrawer: function() {

            document.getElementById('app-entry').openDrawer();
        },

        _openToolsDrawer: function() {

            this.$.toolsDrawer.open();
        },

        _openSelectFolderDialog: function () {

            this.$.selectFolderDialog.open();
        },

        _openConfirmationRemoveFilesDialog: function() {

            this.$.confirmationRemoveFilesDialog.open();
        },

        _openViewFileDialog: function(id) {

            var id = id || this._currentFile.id;
            var fileIndex = this._getFileIndexFromId(id);
            this.set('_currentFile', this.favoriteFiles[fileIndex]);

            // Open dialog
            this.$.viewFileDialog.open();
            this._selectedFilesId = [];
        },

        _openEditFileDialog: function(id) {

            // Open dialog
            this.$.editFileDialog.open();
            this._selectedFilesId = [];
        },

        _openAddFileDialog: function() {

            // Open dialog
            this._resetCurrentFile();
            this.$.addFileDialog.open();
            this._selectedFilesId = [];
        },

        /* TEST FUNCTION */
        _multipleSelected: function(_selectedFilesIdLength) {

            return (_selectedFilesIdLength >= 1);
        },

        /* ACTIONS FUNCTION */
        _doAction: function(type, id) {

            switch(type) {

                case 'edit':
                    this._openEditFileDialog(id);
                    break;

                case 'view':
                    this._openViewFileDialog(id);
                    break;
            }

            this._action = {};

        },

        // Copy selected file content (url or text) to clipboard
        _copyFileLink: function() {
            var textToCopy = " ";

            var selectedFilesIds = this._getFileIndexFromIds();
            var favoriteFiles = this.favoriteFiles;

            // Add each selected file content
            for(var i = 0; i < selectedFilesIds.length; i++) {

                var fileIndex = selectedFilesIds[i];
                var file = favoriteFiles[fileIndex];

                var content = file.content;

                textToCopy += content + " ";

            }

            var appShell = document.getElementById('app-entry');

            appShell.showToast('Successfully copied to your clipboard');
            appShell.copyToClipboard(textToCopy);

        },

        // Delete selected images
        _deleteFile: function() {

            // Save previous file statements
            this._previousFavoriteFiles = this.favoriteFiles;

            // Delete selected index
            var indexToDelete = this._getFileIndexFromIds();

            // Sort array from bigger to smaller
            indexToDelete.sort(function(a, b){

                return b - a;
            });

            // Delete files
            for(var i = 0; i < indexToDelete.length; i++) {

                var index = indexToDelete[i];
                this.splice('favoriteFiles', index, 1);
            }

            this._selectedFilesId = [];

        },

        _undoDeleteFile: function() {

            this.set('favoriteFiles', this._previousFavoriteFiles);
        },

        _saveFile: function() {

            // Save change
            var idToUpdate = this._currentFile.id;
            var indexToUpdate = this._getFileIndexFromId(idToUpdate);
            var pathToUpdate = 'favoriteFiles.' + indexToUpdate;

            var file = this._currentFile;
            var image = this._computeImageFromFile(file);
                file.image = image;
                file.created = Date.now();

            if(typeof file.manualTags !== "object") {

                file.manualTags = [""];
            }

            // Update file object
            this.set(pathToUpdate, file);

            // Notify change on image and name
            this.set(pathToUpdate + '.name', file.name);
            this.set(pathToUpdate + '.image', file.image);


            // Update shared if needed
            if(typeof file.shared !== 'undefined') {

                if(file.shared) {

                    var sharedFileIndex = this._getSharedFileIndexFromId(file.id);

                    if(sharedFileIndex >= 0){

                        // Update shared file
                        var path = 'favoriteSharedFiles' + sharedFileIndex;
                        this.set(path, file);

                    }else {

                        // Add shared file
                        this.push('favoriteSharedFiles', file);
                    }

                }else {

                    var sharedFileIndex = this._getSharedFileIndexFromId(file.id);

                    if(sharedFileIndex >= 0) {

                        // Remove shared file
                        this.splice('favoriteSharedFiles', sharedFileIndex, 1);
                    }

                }

            }

        },

        _openFileLink: function() {

            var filesIndex = this._getFileIndexFromIds();
            var favoriteFiles = this.favoriteFiles;

            for(var i = 0; i < filesIndex.length; i++) {

                var index = filesIndex[i];
                var file = favoriteFiles[index];

                var isLink = this._isFileALink(file);

                if(isLink) {

                    // Open link
                    window.open(file.content);
                }else {

                    // Open file
                    this._openViewFileDialog(file.id);
                }

            }

        },

        // Add one image
        _addFile: function() {

            var file = this._currentFile;
            var image = this._computeImageFromFile(file);

            file.image = image;
            file.id = this._generateId();
            file.created = Date.now();

            if(typeof file.manualTags !== "object") {

                file.manualTags = [""];
            }

            this.push('favoriteFiles', file);
            this._resetCurrentFile();
        },

        /* ACTIONS FUNCTION UTILS */

        _computeTagsFromFile: function(file) {

            if(typeof file === 'undefined') {

                return [];
            }

            var tags = [];

            if(this._isFileALink(file)) { // File is a link

                var url = file.content;

                function extractDomain(url) {
                    var domain;
                    //find & remove protocol (http, ftp, etc.) and get domain
                    if (url.indexOf("://") > -1) {
                        domain = url.split('/')[2];
                    }
                    else {
                        domain = url.split('/')[0];
                    }

                    //find & remove port number
                    domain = domain.split(':')[0];

                    return domain;
                }

                var domain = extractDomain(url);

                tags.push(domain);

                if(url.includes('.png') || url.includes('.jpg') || url.includes('.jpeg') || url.includes('.gif')){

                    tags.push('media');
                    tags.push('image');
                    tags.push('photo');

                }else if(url.includes('docs.google.com/document')) {

                    tags.push('file');
                    tags.push('doc');
                    tags.push('google');
                    tags.push('document');
                }else if(url.includes('docs.google.com/drawings')) {

                    tags.push('file');
                    tags.push('doc');
                    tags.push('document');
                    tags.push('google');
                    tags.push('drawing');
                }else if(url.includes('docs.google.com/forms')) {

                    tags.push('file');
                    tags.push('google');
                    tags.push('form');
                }else if(url.includes('docs.google.com/spreadsheets')) {

                    tags.push('file');
                    tags.push('doc');
                    tags.push('document');
                    tags.push('google');
                    tags.push('spreadsheet');
                    tags.push('sheet');
                }else if(url.includes('docs.google.com/presentation')) {

                    tags.push('file');
                    tags.push('doc');
                    tags.push('document');
                    tags.push('files');
                    tags.push('google');
                    tags.push('presentation');
                }else if(url.includes('github.com')) {

                    tags.push('file');
                    tags.push('files');
                    tags.push('doc');
                    tags.push('document');
                    tags.push('github');
                    tags.push('it');
                }else if(url.includes("soundcloud.com")) {

                    tags.push('media');
                    tags.push('sound');
                    tags.push('soundcloud');
                }else if(url.includes("youtube.com")) {

                    tags.push('media');
                    tags.push('video');
                    tags.push('youtube');
                    tags.push('google');
                }else if(url.includes("twitch.tv")) {

                    tags.push('media');
                    tags.push('video');
                    tags.push('gaming');
                    tags.push('streaming');
                }else if(url.includes("pornhub.com")) {

                    tags.push('media');
                    tags.push('video');
                }

            }else {  // File is a md/html file

                tags.push(file.name);
                tags.push('file');
                tags.push('doc');
                tags.push('document');
                tags.push('md');
                tags.push('markdown');
            }

            return tags;

        },

        _computeImageFromFile: function(file) {

            file.url = file.content;

            if(file.url.includes('.png') || file.url.includes('.jpg') || file.url.includes('.jpeg') || file.url.includes('.gif')){

                return file.url;

            }else if(file.url.includes('docs.google.com/document')) {

                return  'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/google/docs.png?raw=true';
            }else if(file.url.includes('docs.google.com/drawings')) {

                return  'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/google/drawing.png?raw=true';
            }else if(file.url.includes('docs.google.com/forms')) {

                return  'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/google/forms.png?raw=true';
            }else if(file.url.includes('docs.google.com/spreadsheets')) {

                return  'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/google/sheets.png?raw=true';
            }else if(file.url.includes('docs.google.com/presentation')) {

                return  'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/google/slides.png?raw=true';
            }else if(file.url.includes('github.com')) {

                return  'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/github/octocat.png?raw=true';
            }else if(file.url.includes("soundcloud.com")) {

                return 'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/other/soundcloud.png?raw=true';
            }else if(file.url.includes("youtube.com")) {

                var videoId = file.url
                        .replace('https://www.youtube.com/watch?v=', '')
                        .replace('https://youtu.be/', '');

                return 'https://img.youtube.com/vi/' + videoId + '/0.jpg';
            }else if(file.url.includes("twitch.tv")) {

                return 'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/other/twitch.png?raw=true';
            }else if(file.url.includes("pornhub.com")) {

                return 'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/other/pornhub-logo.jpg?raw=true';
            }else {

                return 'https://github.com/esteem8app/esteem8app.github.io/blob/master/src/images/other/txt.png?raw=true';
            }

            return file.url;
        },

        _setCurrentFileName: function(url) {

        },

        _setCurrentFileDefaultTags: function(content) {

            var defaultTags = this._computeTagsFromFile(this._currentFile);

            this.set('_currentFile.defaultTags', defaultTags);
        },

        /* UTILS FUNCTION */

        _resetSelection: function() {

            this._selectedFilesId = [];
        },

        _resetCurrentFile: function() {

            var file = {
                name: '',
                content: '',
                manualTags: []
            };

            this.set('_currentFile', file);
        },

        _generateId: function() {

            return Date.now() * Math.random();
        },

        _isFileALink: function(file) {

            // is file a link or a content
            var fileContent = file.content.replace(/ /gm, '');
            return fileContent.match(/(https?:\/\/)?[a-zA-Z0-9]*\.[a-zA-Z0-9\.]*\/[a-zA-Z0-9-\.\/\%\&\=\?\+]*/);
        },

        _getFileIndexFromIds: function(idList) {

            var indexList = [];

            var idList = idList || this._selectedFilesId;
            var idListLength = idList.length;

            var files = this.favoriteFiles;
            var filesLength = files.length;

            for(var id = 0; id < idListLength; id++) { // For each file id

                var fileId = idList[id];

                for(var index = 0; index < filesLength; index++) { // Check in each file

                    var file = files[index];

                    if(file.id == fileId) { // If the file has the desired id

                        indexList.push(index); // Save the id
                    }

                }

            }

            return indexList;

        },

        _getSharedFileIndexFromIds: function(idList) {

            var indexList = [];

            var idList = idList || this._selectedFilesId;
            var idListLength = idList.length;

            var files = this.favoriteSharedFiles;
            var filesLength = files.length;

            for(var id = 0; id < idListLength; id++) { // For each file id

                var fileId = idList[id];

                for(var index = 0; index < filesLength; index++) { // Check in each file

                    var file = files[index];

                    if(file.id == fileId) { // If the file has the desired id

                        indexList.push(index); // Save the id
                    }

                }

            }

            return indexList;

        },

        _getFileIndexFromId: function(id) {

            var idList = [id];
            var indexList = this._getFileIndexFromIds(idList);

            return indexList[0];
        },

        _getSharedFileIndexFromId: function(id) {

            var idList = [id];
            var indexList = this._getSharedFileIndexFromIds(idList);

            return indexList[0];
        },


        /* SEARCH (FILTER) */
        computeFilter: function(string) {
            if (!string) {
                // set filter to null to disable filtering
                return null;
            } else {

                // return a filter function for the current search string
                string = string.toLowerCase();

                return function(item) {

                    // Set variables
                    var statement = false;
                    var fileName = item.name.toLowerCase();

                    var keys = string.split(' ');
                    var keysLength = keys.length;

                    var manualTags = [];
                    var defaultTags = [];

                    if(typeof item.manualTags !== 'undefined') {

                        manualTags = item.manualTags;
                    }

                    if(typeof item.defaultTags !== 'undefined') {

                        defaultTags = item.defaultTags || [];
                    }

                    var tags = manualTags.concat(defaultTags);
                    var tagsLength = tags.length;


                    /*
                     *
                     *      Tag can contain anything exept "," and ", "
                     *      Tag are separated by "," or ", "
                     *
                     */

                    /* If mutliples key, restrictive filter (image + esteem8 = not only image but image with esteem8) */

                    /*
                     * This function search on tags and name,
                     * the queryString is composed of multiples keywords
                     * Only one keyword can be used to search on name, but the keyword can be in the middle of the array
                     */

                    if(keysLength == 1) { // One keyword in string

                        /*
                         * The keyword need to be equals to a tag or contained in name
                         */

                        // First keyword
                        if(fileName.includes(keys[0].replace(/\-/gm, ' '))) { // String part of the name

                            statement = true;
                        }

                        for(var i = 0; i < tagsLength; i++) { // String equal to a tag

                            var tag = tags[i].toLowerCase();

                            if(tag == keys[0]) {
                                statement = true;
                            }
                        }
                    }else {

                        /*
                         * All first keyword need to be equals to a tag
                         * The last keyword of the keyword set need to be equals to a tag or contained in the name
                         */

                        var allFirstKeywordMatch = true;

                        // All first keyword
                        for(var i = 0; i < keysLength-1; i++) { // For all keyword

                            var key = keys[i];

                            var keyXYStatement = false;

                            for(var j = 0; j < tagsLength; j++) { // keyword equal to a tag

                                var tag = tags[j].toLowerCase();

                                if(tag == key) {
                                    keyXYStatement = true;
                                }
                            }

                            if(!keyXYStatement) {

                                allFirstKeywordMatch = false;
                            }

                        }

                        var lastKeywordOfTheListMatch = false;
                        var lastKeywordOfTheList = keys[keysLength-1].replace(/\-/gm, ' ');

                        for(var i = 0; i < tagsLength; i++) { // String equal to a tag

                            var tag = tags[i].toLowerCase();

                            if(tag == lastKeywordOfTheList) {
                                lastKeywordOfTheListMatch = true;
                            }
                        }

                        if(fileName.includes(lastKeywordOfTheList)) { // String part of the name

                            lastKeywordOfTheListMatch = true;
                        }

                        if(lastKeywordOfTheListMatch && allFirstKeywordMatch) {

                            statement = true;
                        }

                    }

                    return statement;
                };
            }
        }

        //http://uploads.im/apidocs
    });
</script>