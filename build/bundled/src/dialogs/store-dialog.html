<html><head><link rel="import" href="../../bower_components/polymer/polymer.html">

<link rel="import" href="../../bower_components/neon-animation/animations/scale-up-animation.html">
<link rel="import" href="../../bower_components/neon-animation/animations/fade-out-animation.html">

<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">

<link rel="import" href="../../bower_components/paper-toolbar/paper-toolbar.html">
<link rel="import" href="../../bower_components/paper-styles/paper-styles.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-dialog-scrollable/paper-dialog-scrollable.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-card/paper-card.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-icon-item.html">
<link rel="import" href="../../bower_components/paper-item/paper-item-body.html">
<link rel="import" href="../../bower_components/paper-input/paper-input.html">
<link rel="import" href="../../bower_components/paper-fab/paper-fab.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tabs.html">
<link rel="import" href="../../bower_components/paper-tabs/paper-tab.html">

<link rel="import" href="../../bower_components/granite-qrcode-generator/granite-qrcode-generator.html">
<link rel="import" href="../../bower_components/qr-code/src/qr-code.html">

<link rel="import" href="../shared-styles.html">
<link rel="import" href="../components/order-card.html">
<link rel="import" href="../components/my-icons.html">

</head><body><dom-module id="store-dialog">

    <template>

        <style include="shared-styles">

            :host {
                padding: 0;
            }

            #storeDialog {
                width: 100%;
                height: 100%;
                margin: 0;
                background-color: var(--app-primary-background-color);
                color: var(--app-background-primary-text-color);
            }

            #storeToolbar {
                margin: 0;
                padding: 0;
                background-color: var(--app-primary-color);
                color: var(--app-primary-text-color);
            }

            #tabs {
                margin: 0 !important;
                padding: 0 !important;
            }

            paper-input, paper-textarea {
                --paper-input-container-focus-color: var(--app-secondary-color);
                --paper-input-container-input-color: var(--app-background-primary-text-color);
                --paper-input-container-color: var(--app-background-secondary-text-color);
            }

            .header paper-input, .header paper-textarea {
                --paper-input-container-focus-color: var(--app-secondary-text-color);
                --paper-input-container-input-color: var(--app-secondary-text-color);
                --paper-input-container-color: var(--app-secondary-text-color);
            }

            paper-button {
                height: 42px;
            }

            paper-dialog {
                background-color: var(--app-secondary-background-color);
                color: var(--app-background-primary-text-color);
            }

            paper-listbox {
                background-color: var(--app-secondary-background-color);
            }

            paper-listbox paper-item {
                color: var(--app-background-primary-text-color);
            }

            #scrollable {
                margin-bottom: 0px;
                margin-top: 0px;
                padding-right: 0;
                padding-top: 48px;
                padding-left: 0;
                height: calc(100vh - 118px) !important;
            }

            #catalogue {
                @apply(--layout-horizontal);
                padding-top: 16px;
                padding-left: 16px;
                padding-right: 16px;
            }

            #left, #right{
                @apply(--layout-flex);
                min-height: 100% !important;
            }

            #right {
                max-width: 400px !important;
            }

            #categories {
                padding-bottom: 16px;
                border-bottom: 1px solid var(--app-background-secondary-text-color);
            }

            #products {
                padding-top: 16px;
            }

            #orderCard {
                width: calc(100% - 32px);
                margin-left: 16px;
                margin-right: 16px;
            }

            #orderCard .header {
                background-color: var(--app-secondary-color);
                color: var(--app-secondary-text-color);
                padding: 16px;
            }

            .info {
                padding: 0;
                @apply(--layout-horizontal);
            }

            .info .infoSpace {
                @apply(--layout-flex);
            }

            #openCloseOrderDialogButton {
                background-color: var(--app-secondary-background-color);
                color: var(--app-background-primary-text-color);
                margin-left: 16px;
            }

            .order-list {
                padding-top: 16px;
                padding-bottom: 24px;
            }

            #right #orderCard .body {
                overflow: auto;
                height: calc(100vh - 246px) !important;
            }

            .floatRight {
                float: right;
            }

            #toggleViewfab {
                z-index: 8;
                display: none;
                position: fixed;
                bottom: 0;
                right: 0;
                margin: 16px;
                background-color: var(--app-secondary-color);
                color: var(--app-secondary-text-color);
            }

            @media (max-width: 700px) {

                #toggleViewfab {
                    display: block;
                }

            }

            div[name="orders"] {
                width: 100%;
                height: calc(100vh - 118px);
                overflow: auto;
                text-align: center;
            }

            #deleteOrderDialog {
                padding: 16px;
            }

            #closeOrderDialog paper-input {
                margin-top: 0;
            }

            #paymentQrCode {
                text-align: center;
            }

        </style>

        
        <paper-dialog id="selectOptionDialog" with-backdrop="">

            <h2>Select [[_optionsToSelect.name]]</h2>

            <paper-listbox id="variantsList">
                <template is="dom-repeat" items="[[_optionsToSelect.variants]]">

                        <paper-item on-tap="_selectThisVariant()">
                            [[item.type]]
                        </paper-item>
                </template>
            </paper-listbox>

        </paper-dialog>

        
        <paper-dialog id="editOrderProductModal" with-backdrop="">

            <h2>Edit [[_productToEdit.name]]</h2>

            <paper-input label="price" type="number" value="[[_productToEdit.priceValue]]">
                <span suffix="">[[_productToEdit.priceType]]</span>
            </paper-input>

            <paper-textarea label="Note" value="[[_productToEdit.note]]">
            </paper-textarea>

            <div class="productEditNumberBox">
                Number
                <paper-button id="removeEditedProductNumberButton" on-tap="_removeEditedProductNumber()"> - </paper-button>
                [[_productToEdit.number]]
                <paper-button id="addEditedProductNumberButton" on-tap="_addEditedProductNumber()"> + </paper-button>
            </div>

            <div class="buttons">
                <paper-button dialog-dismiss="">
                    Cancel
                </paper-button>
                <paper-button dialog-confirm="" autofocus="" id="saveEditedProductButton" on-tap="_saveEditedProduct()">
                    OK
                </paper-button>
            </div>

        </paper-dialog>

        
        <paper-dialog id="closeOrderDialog" with-backdrop="">

            <h2 class="orderTotalPrice">[[_computeTotalOrder(_order.products, _order.products.length)]] SBD</h2>

            <div id="paymentQrCode">
                <qr-code data="https://esteem8.com/@esteem8/wallet/send/SBD"></qr-code>
            </div>

            <paper-input label="Request" value="{{_order.who}}">
                <span prefix="">@</span>
                <paper-icon-button icon="my-icons:assign" suffix="">
                </paper-icon-button>
            </paper-input>

            <div class="buttons">
                <paper-button dialog-dismiss="">
                    Cancel
                </paper-button>
                <paper-button dialog-confirm="" autofocus="" id="closeOrderButton" on-tap="_closeOrder()">
                    OK
                </paper-button>
            </div>

        </paper-dialog>

        
        <paper-dialog id="deleteOrderDialog" with-backdrop="">

            <h2>Confirmation</h2>

            Are you sure to delete this order ?

            <div class="buttons">
                <paper-button dialog-dismiss="">
                    Cancel
                </paper-button>
                <paper-button dialog-confirm="" autofocus="" id="deleteOrderButton" on-tap="_deleteOrder()">
                    OK
                </paper-button>
            </div>

        </paper-dialog>

        
        <paper-dialog id="storeDialog" opened="{{isOpen}}" entry-animation="fade-in-animation" exit-animation="fade-out-animation" with-backdrop="">

            <paper-toolbar id="storeToolbar">

                <paper-icon-button icon="my-icons:close" dialog-dismiss="">
                </paper-icon-button>

                <span class="title">My store</span>

                <paper-icon-button id="toggleFullscreenButton" on-tap="_toggleFullscreen()" icon="my-icons:fullscreen">
                </paper-icon-button>

            </paper-toolbar>

            
            <div class="secondBar" id="tabs">
                <paper-tabs selected="{{_view}}" attr-for-selected="name" fit-container="" no-slide="">
                    <paper-tab name="pos">
                        <iron-icon icon="my-icons:book"></iron-icon>
                        POS
                    </paper-tab>
                    <paper-tab name="orders">
                        <iron-icon icon="my-icons:person"></iron-icon>
                        ORDERS
                    </paper-tab>
                </paper-tabs>
            </div>

            <paper-fab id="toggleViewfab">
                <iron-icon icon="my-icon:visibility"></iron-icon>
            </paper-fab>

            <div id="scrollable">

                <iron-pages selected="[[_view]]" attr-for-selected="name">

                    <div id="catalogue" name="pos">

                        <div id="left">

                            <div id="categories">

                                <paper-icon-button id="previousCategoryButton" icon="my-icons:arrow-back" on-tap="_previousCategory()">
                                </paper-icon-button>

                                <template is="dom-repeat" items="[[favoriteCategories]]" filter="{{_categoriesFilter(_query)}}">
                                    <paper-button on-tap="_changeCategory()" raised="" style="background-color: [[item.color]]; color: [[item.textColor]]">
                                        [[item.name]]
                                    </paper-button>
                                </template>

                            </div>

                            <div id="products">

                                <template is="dom-repeat" items="[[favoriteProducts]]" filter="{{_productsFilter(_query)}}">
                                    <paper-button on-tap="_addProduct()">
                                        [[item.name]]
                                    </paper-button>
                                </template>

                            </div>

                        </div>

                        <div id="right">

                            <paper-card id="orderCard">

                                <div class="header">

                                    <paper-textarea label="Note" value="{{_order.note}}">
                                    </paper-textarea>

                                    <paper-input label="Place" value="{{_order.place}}">
                                    </paper-input>

                                    <paper-item class="info">
                                        <span>[[_order.products.length]] products</span>

                                        <div class="infoSpace"></div>

                                        <span>[[_computeTotalOrder(_order.products, _order.products.length)]] SBD</span>
                                        <paper-button id="openCloseOrderDialogButton" on-tap="_openCloseOrderDialog()">
                                            Pay
                                        </paper-button>
                                    </paper-item>
                                </div>

                                <div class="body">

                                    <paper-listbox id="orderProducts">

                                        <template is="dom-repeat" items="[[_order.products]]">
                                            <paper-item on-tap="_editOrderProduct()">
                                                <paper-item-body two-line="">
                                                    <div>
                                                    <span>[[item.number]] x [[item.name]]<span>
                                                    <span class="floatRight">[[_computeProductPrice(item)]]<span>
                                                    </span></span></span></span></div>
                                                    <div secondary="">
                                                        [[item.selectedVariant]] [[_computeNote(item.note)]]
                                                    </div>
                                                </paper-item-body>
                                            </paper-item>
                                        </template>

                                    </paper-listbox>

                                </div>
                            </paper-card>

                        </div>

                    </div>

                    <div name="orders">

                        <div class="order-list">

                            <template is="dom-repeat" items="[[manualOrdersHistory]]" sort="{{_ordersSorting()}}">

                                <order-card order="[[item]]" action="{{_action}}">
                                </order-card>
                            </template>
                        </div>
                    </div>

                </iron-pages>

            </div>

        </paper-dialog>
    </template>
</dom-module>

<script>Polymer({is:"store-dialog",properties:{isOpen:{type:Boolean,notify:!0},favoriteCategories:{type:Array,notify:!0},favoriteProducts:{type:Array,notify:!0},manualOrdersHistory:{type:Array,notify:!0},_query:{type:String},_order:{type:Object},_optionsToSelect:{type:Object},_productIndexToEdit:{type:String},_productToEdit:{type:Object},_isFullScreen:{type:Boolean},_view:{type:String},_action:{type:Object}},listeners:{"categories.tap":"_changeCategory","products.tap":"_addProduct","variantsList.tap":"_selectThisVariant","orderProducts.tap":"_editOrderProduct"},observers:["_doAction(_action.id)"],ready:function(){this._query="",this._view="pos",this._optionsToSelect={},this._productToEdit={},this._productIndexToEdit=0,this._order={products:[]},this._isFullScreen=!1,this.$.previousCategoryButton.addEventListener("tap",this._previousCategory.bind(this)),this.$.removeEditedProductNumberButton.addEventListener("tap",this._removeEditedProductNumber.bind(this)),this.$.addEditedProductNumberButton.addEventListener("tap",this._addEditedProductNumber.bind(this)),this.$.saveEditedProductButton.addEventListener("tap",this._saveEditedProduct.bind(this)),this.$.openCloseOrderDialogButton.addEventListener("tap",this._openCloseOrderDialog.bind(this)),this.$.closeOrderButton.addEventListener("tap",this._closeOrder.bind(this)),this.$.deleteOrderButton.addEventListener("tap",this._deleteOrder.bind(this))},open:function(){this.isOpen=!0},_isViewOrders:function(t){return"orders"==t},_isViewPos:function(t){return"pos"==t},_openCloseOrderDialog:function(){this.$.closeOrderDialog.open()},_doAction:function(){this.$.deleteOrderDialog.open()},_closeOrder:function(){this._order.total=this._computeTotalOrder(this._order.products,this._order.products.length);var t=document.getElementById("appshell");t.showToast("Order closed, "+this._order.total+" gained"),this._order.created=Date.now(),this._order.id=this._generateId(),this.push("manualOrdersHistory",this._order),this._order={products:[]}},_deleteOrder:function(){for(var t=this.manualOrdersHistory,e=this._action.id,r=0,o=0;o<t.length;o++)t[o].id==e&&(r=o);r>=0&&this.splice("manualOrdersHistory",r,1)},_addProduct:function(t){var e=t.model.item;e.selectedVariant="",e.number=1,e.inOrderId=this._generateId(),"undefined"!=typeof e.options[0]&&e.options[0].name&&e.options[0].variants.length?(this._optionsToSelect=e.options[0],this._optionsToSelect.productInOrderId=e.inOrderId,this.$.selectOptionDialog.open()):this.$.selectOptionDialog.close(),this.push("_order.products",e)},_changeCategory:function(t){var e=t.model.item,r=[];r.push(e.name);var o=e.parent;""!==o&&r.push(o),r.reverse(),this._query=r.join(" ")},_previousCategory:function(){var t=this._query.split(" ");t.pop(),t.length?this._query=t.join(" "):this._query=""},_computeFullscreenIcon:function(t){return t?"fullscreen-exit":"fullscreen"},_removeEditedProductNumber:function(){var t=parseInt(this._productToEdit.number);t-=1,t>0&&this.set("_productToEdit.number",t)},_addEditedProductNumber:function(){var t=parseInt(this._productToEdit.number);t+=1,this.set("_productToEdit.number",t)},_selectThisVariant:function(t){var e=t.model.item,r=this._getIndexProductById(this._optionsToSelect.productInOrderId),o="_order.products."+r+".selectedVariant";this.set(o,e.type),this.$.selectOptionDialog.close(),this._optionsToSelect={}},_editOrderProduct:function(t){var e=t.model.item;this._productToEdit=e,this._productIndexToEdit=this._order.products.indexOf(e),this.$.editOrderProductModal.open()},_saveEditedProduct:function(){var t="_order.products."+this._productIndexToEdit;this.set(t,this._productToEdit),this.set(t+".priceValue",this._productToEdit.priceValue),this.set(t+".number",this._productToEdit.number),this.set(t+".note",this._productToEdit.note)},_computeProductPrice:function(t){return t.number*t.priceValue+" "+t.priceType},_computeTotalOrder:function(t,e){for(var r=0,o=0;o<t.length;o++){var i=parseInt(t[o].number),n=parseInt(t[o].priceValue);r+=i*n}return r},_computeNote:function(t){return"undefined"!=typeof t?", "+t:""},_ordersSorting:function(){return function(t,e){return t.created<e.created}},_categoriesFilter:function(t){return t=t.toLowerCase(),function(e){var r=e.parent.toLowerCase(),o=t.split(" "),i=o.length,n=o[i-1];return n==r}},_productsFilter:function(t){return t?(t=t.toLowerCase(),function(e){var r=(e.name.toLowerCase(),t.split(" ")),o=r.length,i=[];"undefined"!=typeof e.tags&&(i=e.tags);for(var n=i.length,d=!0,s=0;s<o;s++){for(var u=r[s],a=!1,c=0;c<n;c++){var p=i[c].toLowerCase();p==u&&(a=!0)}a||(d=!1)}return d}):null},_getIndexProductById:function(t){for(var e=this._order.products,r=0;r<e.length;r++){var o=e[r];if(o.inOrderId===t)return r}return-1},_generateId:function(){var t=Date.now()*Math.random();return t}});</script></body></html>