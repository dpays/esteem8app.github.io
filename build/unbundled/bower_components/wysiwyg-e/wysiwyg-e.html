<html><head><link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../app-localize-behavior/app-localize-behavior.html">
<link rel="import" href="../font-roboto/roboto.html">
<link rel="import" href="../iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../iron-icon/iron-icon.html">
<link rel="import" href="../iron-icons/hardware-icons.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-media-query/iron-media-query.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-item/paper-item.html">
<link rel="import" href="../paper-listbox/paper-listbox.html">
<link rel="import" href="../paper-menu-button/paper-menu-button.html">
<link rel="import" href="../paper-tooltip/paper-tooltip.html">
<link rel="import" href="../prism-element/prism-import.html">
<link rel="import" href="../selection-mgr/behavior.html">
<link rel="import" href="../undo-mgr/behavior.html">



</head><body><dom-module id="wysiwyg-e">
	<template>
		<style include="iron-flex iron-flex-alignment iron-flex-factors iron-positioning"></style>
		<style>
			:host {
				display: block;
				position: relative;
				overflow-y: hidden;
				font-family: var(--wysiwyg-font, Roboto);
			}

			#toolbar {
				--paper-toolbar-height: auto;
				background: var(--wysiwyg-toolbar-background, #2A9AF2);
				user-select: none;
				color: var(--wysiwyg-toolbar-color, white);
				@apply(--wysiwyg-toolbar);
			}

			#editable {
				padding: 20px;
				outline: none;
				@apply(--wysiwyg-editable);
				@apply(--layout-flex);
			}

			#editable :first-child {
				margin-top: 0;
				@apply(--wysiwyg-editable-first-child);
			}

			#editable :last-child {
				margin-bottom: 0;
				@apply(--wysiwyg-editable-last-child);
			}

			#editable ::selection {
				color: white;
				background: #2A9AF2;
				@apply(--wysiwyg-editable-selection);
			}

			#editable ol {
				padding-left: 30px;
				@apply(--wysiwyg-editable-ol);
			}

			#editable ul {
				padding-left: 30px;
				@apply(--wysiwyg-editable-ul);
			}

			#editable li {
				@apply(--wysiwyg-editable-li);
			}

			#editable a {
				color: #2A9AF2;
				@apply(--wysiwyg-editable-a);
			}

			#editable img {
				@apply(--wysiwyg-editable-img);
			}

			#editable blockquote {
				padding: 15px;
				margin: 0;
				border-left: 5px solid #eee;
				@apply(--wysiwyg-editable-blockquote);
			}

			#editable code {
				display: block;
				padding: 16px;
				line-height: 1.5;
				background-color: #f7f7f7;
				border-radius: 3px;
				@apply(--wysiwyg-editable-pre);
			}

			#editable p {
				@apply(--wysiwyg-editable-p);
			}

			#editable h1 {
				@apply(--wysiwyg-editable-h1);
			}

			#editable h2{
				@apply(--wysiwyg-editable-h2);
			}

			#editable h3 {
				@apply(--wysiwyg-editable-h3);
			}

			#editable h4 {
				@apply(--wysiwyg-editable-h4);
			}

			#editable h5 {
				@apply(--wysiwyg-editable-h5);
			}

			#editable h6 {
				@apply(--wysiwyg-editable-h6);
			}

			#editable b {
				@apply(--wysiwyg-editable-b);
			}

			#editable u {
				@apply(--wysiwyg-editable-u);
			}

			#editable i {
				@apply(--wysiwyg-editable-i);
			}

			#editable strike {
				@apply(--wysiwyg-editable-strike);
			}

			#editable audio-wrapper,
			#editable video-wrapper {
				display: block;
			}

			:host([mode="edit"]) #editable audio,
			:host([mode="edit"]) #editable video {
				pointer-events: none;
			}

			#html {
				padding: 0 20px 20px 20px;
				@apply(--wysiwyg-html);
				@apply(--layout-flex);
			}

			#html pre {
				margin: 0;
				@apply(--wysiwyg-html-pre);
			}

			#html code {
				display: block;
				word-wrap: break-word;
				@apply(--wysiwyg-html-code);
			}

			paper-button {
				padding: 0;
				margin: 0;
				height: 40px;
				line-height: 40px;
				border-radius: 0px;
				min-width: 40px;
				background: transparent;
				text-transform: none;
			}

			paper-menu-button {
				padding: 0;
			}

			paper-item:hover {
				cursor: pointer;
			}

			:host([mode="read"]) ::content .wysiwyg-tool,
			:host([mode="html"]) ::content .wysiwyg-tool {
				visibility: hidden;
			}

			@media (min-width: 768px) {
				#layout {
					@apply(--layout-vertical);
				}

				#toolbarLayout {
					@apply(--layout-horizontal);
					@apply(--layout-wrap);
					@apply(--layout-center-justified);
				}

				#layout[force-narrow] {
					@apply(--layout-horizontal);
				}

				#layout[force-narrow] #toolbarLayout {
					@apply(--layout-vertical);
					width: 40px;
					max-height: calc(100% - 80px);
					overflow-y: hidden;
				}
			}

			@media (max-width: 767px) {
				#layout {
					@apply(--layout-horizontal);
				}

				#toolbarLayout {
					@apply(--layout-vertical);
					width: 40px;
					max-height: calc(100% - 80px);
					overflow-y: hidden;
				}
			}

			#content {
				overflow-y: auto;
				@apply(--layout-flex);
				@apply(--layout-vertical);
			}

			#scrollUp,
			#scrollDown {
				border-radius: 0;
			}

			#scrollUp[disabled],
			#scrollDown[disabled] {
				color: rgba(255, 255, 255, 0.5);
			}
		</style>
		<iron-a11y-keys target="[[target]]" keys="backspace" on-keys-pressed="_backspace"></iron-a11y-keys>
		<iron-a11y-keys target="[[target]]" keys="delete" on-keys-pressed="_delete"></iron-a11y-keys>
		<iron-media-query query="(min-width: 768px)" query-matches="{{minWidth768px}}"></iron-media-query>
		<div class="fit" id="layout" force-narrow$="[[forceNarrow]]">
			<paper-toolbar id="toolbar" on-tap="updateTools">
				<paper-button id="scrollDown" on-up="_onScrollButtonUp" on-down="_onScrollUp" hidden$="[[!showScrollButtons]]" disabled="[[!canScrollUp]]">
					<iron-icon icon="hardware:keyboard-arrow-up"></iron-icon>
				</paper-button>
				<div id="toolbarLayout" on-undo="undo" on-redo="redo" scroll-top="[[scrollOffset]]">
					<paper-menu-button id="settings" hidden$="[[hideSettings]]" dynamic-align="">
						<paper-button class="dropdown-trigger">
							<iron-icon icon="settings"></iron-icon>
						</paper-button>
						<paper-listbox class="dropdown-content" selected="{{mode}}" attr-for-selected="mode">
							<paper-item mode="edit">[[localize('Edit')]]</paper-item>
							<paper-item mode="read">[[localize('Read-only')]]</paper-item>
							<paper-item mode="html">[[localize('View HTML')]]</paper-item>
						</paper-listbox>
					</paper-menu-button>
					<paper-tooltip id="tooltip" for="settings" position="[[tooltipPosition]]" offset="5">[[localize('Settings')]]</paper-tooltip>
					<wysiwyg-tool-backspace></wysiwyg-tool-backspace>
					<content select="[wysiwyg-tool]" id="tools"></content>
				</div>
				<paper-button id="scrollUp" on-up="_onScrollButtonUp" on-down="_onScrollDown" hidden$="[[!showScrollButtons]]" disabled="[[!canScrollDown]]">
					<iron-icon icon="hardware:keyboard-arrow-down"></iron-icon>
				</paper-button>
			</paper-toolbar>
			<div id="content">
				<div id="editable" contenteditable$="[[_edit(mode)]]" hidden$="[[_html(mode)]]"></div>
				<div id="html" hidden$="[[!_html(mode)]]">
					<pre>						<code inner-h-t-m-l="[[_prismHighlight(value)]]"></code>
					</pre>
				</div>
			</div>
		</div>
	</template>

	<script>Polymer({is:"wysiwyg-e",behaviors:[Polymer.AppLocalizeBehavior,SelectionMgrBehavior,UndoMgrBehavior],listeners:{keydown:"_keydown","restore-selection":"restoreSelection","select-element":"_selectElement",paste:"_paste"},observers:["updateTools(range0, canRedo, canUndo, value, commonAncestorPath, minWidth768px, tooltipPosition, forceNarrow, mode, language)"],properties:{canScrollUp:{type:Boolean,computed:"_computeCanScrollUp(minWidth768px, forceNarrow, scrollHeight, scrollOffset)"},canScrollDown:{type:Boolean,computed:"_computeCanScrollDown(minWidth768px, forceNarrow, scrollHeight, scrollOffset)"},forceNarrow:{type:Boolean,value:!1},hideSettings:{type:Boolean,value:!1},language:{type:String,value:"en"},minWidth768px:{type:Boolean},mode:{type:String,value:"edit",observer:"_modeChanged",reflectToAttribute:!0},resources:{type:Object,value:function(){return{en:{Settings:"Settings",Edit:"Edit","Read-only":"Read-only","View HTML":"View HTML"}}}},scrollDelay:{type:Number,value:1},scrollStep:{type:Number,value:10},scrollHeight:{type:Number,value:0,readOnly:!0},scrollOffset:{type:Number,value:0,readOnly:!0},showScrollButtons:{type:Boolean,computed:"_computeShowScrollButtons(minWidth768px, forceNarrow)"},target:{type:Object,value:function(){return this.$.editable},observer:"_targetChanged"},tooltipPosition:{type:String,computed:"_computeTooltipPosition(minWidth768px, forceNarrow)"}},ready:function(){Polymer.dom(this.$.tools).observeNodes(function(){this.updateTools()}.bind(this));var e=function(){this._setScrollHeight(Math.max(0,this.$.toolbarLayout.scrollHeight-this.$.toolbarLayout.offsetHeight))}.bind(this);window.addEventListener("resize",e),this.async(e,100)},disconnect:function(){UndoMgrBehavior.disconnect.apply(this,arguments),SelectionMgrBehavior.disconnect.apply(this,arguments)},observe:function(){UndoMgrBehavior.observe.apply(this,arguments),SelectionMgrBehavior.observe.apply(this,arguments)},redo:function(){return"edit"===this.mode&&UndoMgrBehavior.redo.apply(this,arguments)},sanitize:function(){var e,t,o,n,r=Polymer.dom(this.target),l=(r.innerHTML,UndoMgrBehavior.sanitize.apply(this,arguments)),i=this.target.childNodes;for(e=0;e<i.length;e+=1)3===i[e].nodeType&&(l=!1,o=document.createElement("p"),this.target.insertBefore(o,i[e].nextSibling),o.appendChild(i[e]));var s=r.querySelectorAll("pre > :not(code), code > p");for(e=0;e<s.length;e+=1)s[e].outerHTML=s[e].innerHTML,l=!1;for(n=r.querySelectorAll("pre"),e=0;e<n.length;e+=1){var a=0,i=Array.prototype.slice.call(n[e].childNodes),c=n[e];for(t=0;t<i.length;t+=1)if("CODE"===i[t].tagName){if(a+=1,1===a)c=n[e].nextSibling;else if(a>1){var h=document.createElement("pre");h.appendChild(i[t]),n[e].parentNode.insertBefore(h,c),c=h.nextSibling,l=!1}}else o=document.createElement("p"),o.textContent=i[t].textContent,n[e].removeChild(i[t]),n[e].parentNode.insertBefore(o,c),l=!1}var d=r.querySelectorAll("strong");for(e=0;e<d.length;e+=1)d[e].outerHTML="<b>"+d[e].innerHTML+"</b>",l=!1;var u=r.querySelectorAll("em");for(e=0;e<u.length;e+=1)u[e].outerHTML="<i>"+u[e].innerHTML+"</i>",l=!1;var p=r.querySelectorAll("div");for(e=0;e<p.length;e+=1)p[e].outerHTML="<p>"+p[e].innerHTML+"</p>",l=!1;var m=r.querySelectorAll("p");for(e=0;e<m.length;e+=1){var f=m[e].querySelectorAll("p");for(f.length&&(l=!1),t=0;t<f.length;t+=1)f[t].outerHTML=f[t].textContent}var g=r.querySelectorAll("*"),y=["B","I","U","STRIKE","SPAN"];for(e=0;e<g.length;e+=1)if(y.indexOf(g[e].tagName)>=0)g[e].removeAttribute("class");else{var v=[],_=!1,S=!1;for(t=0;t<g[e].classList.length;t+=1)["style-scope","wysiwyg-e"].indexOf(g[e].classList[t])===-1?v.push(g[e].classList[t]):("style-scope"===g[e].classList[t]&&(_=!0),"wysiwyg-e"===g[e].classList[t]&&(S=!0));for(t=0;t<v.length;t+=1)g[e].classList.remove(v[t]),l=!1;_||(g[e].classList.add("style-scope"),l=!1),S||(g[e].classList.add("wysiwyg-e"),l=!1)}if(!r.children.length){o=document.createElement("p");var w=document.createElement("br");o.appendChild(w),r.appendChild(o),l=!1}return l},undo:function(){return"edit"===this.mode&&UndoMgrBehavior.undo.apply(this,arguments)},updateTools:function(){for(var e=Polymer.dom(this.$.tools).getDistributedNodes(),t=0;t<e.length;t+=1)e[t]._setRange0(this.range0),e[t]._setSelectionRoot(this.shadowRoot||document),e[t]._setCanRedo(this.canRedo),e[t]._setCanUndo(this.canUndo),e[t]._setValue(this.value),e[t]._setCommonAncestorPath(this.commonAncestorPath),e[t]._setTarget(this.target),e[t]._setMinWidth768px(this.minWidth768px),e[t]._setForceNarrow(this.forceNarrow),e[t]._setTooltipPosition(this.tooltipPosition),e[t]._setMode(this.mode),e[t].language=this.language},_backspace:function(){this.target.children.length>1?document.execCommand("delete"):1===this.target.children.length&&(this.target.children[0].textContent.length?document.execCommand("delete"):document.execCommand("formatBlock",null,"P"))},_computeCanScrollDown:function(e,t,o,n){return!(e&&!t)&&n<o},_computeCanScrollUp:function(e,t,o,n){return!(e&&!t)&&n>0},_computeShowScrollButtons:function(e,t){return!(e&&!t)},_computeTooltipPosition:function(e,t){return e&&!t?"bottom":"right"},_delete:function(){document.execCommand("forwardDelete")},_edit:function(e,t){return"edit"===this.mode},_html:function(){return"html"===this.mode},_keydown:function(e){this.target.contains(e.target)&&("Delete"===e.key&&e.preventDefault(),"Backspace"===e.key&&e.preventDefault(),(e.altKey||e.ctrlKey||e.metaKey)&&(!e.altKey&&!e.shiftKey&&["a","r","p","v","c","x"].indexOf(e.key)>=0&&(e.ctrlKey||e.metaKey)||e.preventDefault()))},_modeChanged:function(){if(["edit","read","html"].indexOf(this.mode)===-1)return void(this.mode="edit");if(this.target&&"read"!==this.mode){var e=this.target.querySelectorAll("audio, video");if(!e)return;for(var t=0;t<e.length;t+=1)e[t].paused=!0}},_onScrollButtonUp:function(){clearInterval(this._scrollJob),this._scrollJob=null},_onScrollDown:function(){this._scrollDown(),this._scrollJob=setInterval(this._scrollDown.bind(this),this.scrollDelay)},_onScrollUp:function(){this._scrollUp(),this._scrollJob=setInterval(this._scrollUp.bind(this),this.scrollDelay)},_panelMode:function(){return"edit"!==this.mode?"seamed":"waterfall"},_paste:function(e){e.preventDefault();var t=e.clipboardData.getData("text/html");document.execCommand("insertHTML",!1,t)},_prismHighlight:function(e){function t(e){"string"!=typeof e&&(e="");var t=document.createElement("div");return t.innerHTML=e.trim(),o(t,0).innerHTML}function o(e,t){for(var n,r=new Array(t++ +1).join("\t"),l=new Array(t-1).join("\t"),i=0;i<e.children.length;i+=1)n=document.createTextNode("\n"+r),e.insertBefore(n,e.children[i]),o(e.children[i],t),e.lastElementChild==e.children[i]&&(n=document.createTextNode("\n"+l),e.appendChild(n));return e}return Prism.highlight(t(e),Prism.languages.markup)},_scroll:function(e){this._setScrollOffset(this.scrollOffset+e)},_scrollDown:function(){this.scrollOffset+this.scrollStep>this.scrollHeight?(this._scroll(this.scrollHeight-this.scrollOffset),this._onScrollButtonUp()):this._scroll(this.scrollStep)},_scrollUp:function(){this.scrollOffset-this.scrollStep<0?(this._scroll(-this.scrollOffset),this._onScrollButtonUp()):this._scroll(-this.scrollStep)},_selectElement:function(e){this.selectElement(e.detail.element)},_targetChanged:function(){UndoMgrBehavior._targetChanged.apply(this,arguments),SelectionMgrBehavior._targetChanged.apply(this,arguments)},_valueChanged:function(){UndoMgrBehavior._valueChanged.apply(this,arguments)}});</script>
</dom-module>
</body></html>